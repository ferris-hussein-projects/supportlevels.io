{% extends "base.html" %}

{% block title %}Support Tracker - Stock Support Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i data-feather="target" class="me-2"></i>
                Stocks Approaching Support
            </h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                    <i data-feather="bar-chart-2" class="me-1"></i>Dashboard
                </a>
                <a href="{{ url_for('export_csv') }}" class="btn btn-outline-secondary">
                    <i data-feather="download" class="me-1"></i>Export
                </a>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="trending-up" class="me-2"></i>
                            Stocks
                        </h5>
                        <h2 class="text-info">{{ total_stocks or 0 }}</h2>
                        <p class="text-muted mb-0">S&P 500</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="zap" class="me-2"></i>
                            Crypto
                        </h5>
                        <h2 class="text-warning">{{ total_crypto_tracked or 10 }}</h2>
                        <p class="text-muted mb-0">of {{ total_crypto_available or 47 }} coins</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="database" class="me-2"></i>
                            Total
                        </h5>
                        <h2 class="text-success">{{ total_assets or 0 }}</h2>
                        <p class="text-muted mb-0">Assets tracked</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="trending-down" class="me-2"></i>
                            Near Support
                        </h5>
                        <h2 class="text-danger">{{ assets_near_support or 0 }}</h2>
                        <p class="text-muted mb-0">Identified</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="percent" class="me-2"></i>
                            Threshold
                        </h5>
                        <h2 class="text-primary">{{ "%.1f"|format(threshold) }}%</h2>
                        <p class="text-muted mb-0">
                            <a href="{{ url_for('settings') }}" class="text-decoration-none">Configure</a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i data-feather="filter" class="me-2"></i>
                            Filter
                        </h5>
                        <h2 class="text-secondary">{{ sector_filter or 'All' }}</h2>
                        <p class="text-muted mb-0">
                            {% if sector_filter and sector_filter != 'All' %}
                                {{ sector_summary.get(sector_filter, 0) }} total
                            {% else %}
                                All assets
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sector Filter Bar -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="filter" class="me-2"></i>
                            Filter by Sector
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="?{% for key, value in request.args.items() %}{% if key != 'sector' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                               class="btn {% if not sector_filter or sector_filter == 'All' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                                All Assets ({{ total_assets }})
                            </a>
                            {% for sector in all_sectors %}
                            <a href="?sector={{ sector }}{% for key, value in request.args.items() %}{% if key != 'sector' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="btn {% if sector_filter == sector %}btn-primary{% else %}btn-outline-secondary{% endif %} {% if sector.startswith('Crypto:') %}btn-outline-warning{% endif %}">
                                {{ sector }} ({{ sector_summary.get(sector, 0) }})
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i data-feather="alert-circle" class="me-2"></i>
            {{ error }}
        </div>
        {% endif %}

        {% if results %}

<div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i data-feather="list" class="me-2"></i>
                        {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Level Analysis
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Level Type Toggle -->
                        <div class="btn-group" role="group" aria-label="Level type toggle">
                            <a href="{{ url_for('index', level_type='support', sort=sort_by, order=sort_order, sector=sector_filter) }}" 
                               class="btn btn-sm {% if level_type == 'support' %}btn-success{% else %}btn-outline-success{% endif %}">
                                <i data-feather="trending-down" class="me-1"></i>Support
                            </a>
                            <a href="{{ url_for('index', level_type='resistance', sort=sort_by, order=sort_order, sector=sector_filter) }}" 
                               class="btn btn-sm {% if level_type == 'resistance' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                <i data-feather="trending-up" class="me-1"></i>Resistance
                            </a>
                        </div>
<div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i data-feather="list" class="me-2"></i>
                        {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Level Analysis
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Level Type Toggle -->
                        <div class="btn-group" role="group" aria-label="Level type toggle">
                            <a href="{{ url_for('index', level_type='support', sort=sort_by, order=sort_order, sector=sector_filter) }}" 
                               class="btn btn-sm {% if level_type == 'support' %}btn-success{% else %}btn-outline-success{% endif %}">
                                <i data-feather="trending-down" class="me-1"></i>Support
                            </a>
                            <a href="{{ url_for('index', level_type='resistance', sort=sort_by, order=sort_order, sector=sector_filter) }}" 
                               class="btn btn-sm {% if level_type == 'resistance' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                <i data-feather="trending-up" class="me-1"></i>Resistance
                            </a>
                        </div>

                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i data-feather="filter" class="me-1"></i>Sort
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Sort by:</h6></li>
                                <li><a class="dropdown-item{% if sort_by == 'ticker' %} active{% endif %}" 
                                       href="?sort=ticker&order={{ 'desc' if sort_by == 'ticker' and sort_order == 'asc' else 'asc' }}{% if sector_filter and sector_filter != 'All' %}&sector={{ sector_filter }}{% endif %}">
                                    <i data-feather="type" class="me-2"></i>Ticker</a></li>
                                <li><a class="dropdown-item{% if sort_by == 'price' %} active{% endif %}" 
                                       href="?sort=price&order={{ 'desc' if sort_by == 'price' and sort_order == 'asc' else 'asc' }}{% if sector_filter and sector_filter != 'All' %}&sector={{ sector_filter }}{% endif %}">
                                    <i data-feather="dollar-sign" class="me-2"></i>Price</a></li>
                                <li><a class="dropdown-item{% if sort_by == 'distance' %} active{% endif %}" 
                                       href="?sort=distance&order={{ 'desc' if sort_by == 'distance' and sort_order == 'asc' else 'asc' }}{% if sector_filter and sector_filter != 'All' %}&sector={{ sector_filter }}{% endif %}">
                                    <i data-feather="target" class="me-2"></i>Distance to Support</a></li>
                                <li><a class="dropdown-item{% if sort_by == 'popularity' %} active{% endif %}" 
                                       href="?sort=popularity&order={{ 'desc' if sort_by == 'popularity' and sort_order == 'asc' else 'asc' }}{% if sector_filter and sector_filter != 'All' %}&sector={{ sector_filter }}{% endif %}">
                                    <i data-feather="trending-up" class="me-2"></i>Popularity</a></li>
                            </ul>
                        </div>
                        <span class="badge bg-info">{{ stocks_near_support }} found</span>
                        <a href="{{ url_for('export_csv') }}" class="btn btn-outline-secondary btn-sm">
                            <i data-feather="download" class="me-1"></i>Export CSV
                        </a>
                    </div>
                </div>
                <small class="text-muted">
                    Last updated: <span id="lastUpdated"></span> | 
                    Sorted by: <strong>{{ sort_by.title() }}</strong> ({{ sort_order.upper() }})
                </small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">

<th scope="col">
                                <a href="{{ url_for('index', sort='ticker', order='asc' if sort_by != 'ticker' or sort_order == 'desc' else 'desc', sector=sector_filter, level_type=level_type) }}" 
                                   class="text-decoration-none">
                                    Asset <i data-feather="arrow-up-down" class="ms-1"></i>
                                </a>
                            </th>
                            <th scope="col">
                                <a href="{{ url_for('index', sort='price', order='asc' if sort_by != 'price' or sort_order == 'desc' else 'desc', sector=sector_filter, level_type=level_type) }}" 
                                   class="text-decoration-none">
                                    Price <i data-feather="arrow-up-down" class="ms-1"></i>
                                </a>
                            </th>
                            <th scope="col" class="{% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Zones
                            </th>
                            <th scope="col" class="{% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Prices
                            </th>
                            <th scope="col">Sector</th>
                            <th scope="col">Halal</th>
                            <th scope="col">Volume</th>
                            <th scope="col">Actions</th>

<th scope="col">
                                <a href="{{ url_for('index', sort='ticker', order='asc' if sort_by != 'ticker' or sort_order == 'desc' else 'desc', sector=sector_filter, level_type=level_type) }}" 
                                   class="text-decoration-none">
                                    Asset <i data-feather="arrow-up-down" class="ms-1"></i>
                                </a>
                            </th>
                            <th scope="col">
                                <a href="{{ url_for('index', sort='price', order='asc' if sort_by != 'price' or sort_order == 'desc' else 'desc', sector=sector_filter, level_type=level_type) }}" 
                                   class="text-decoration-none">
                                    Price <i data-feather="arrow-up-down" class="ms-1"></i>
                                </a>
                            </th>
                            <th scope="col" class="{% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Zones
                            </th>
                            <th scope="col" class="{% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                {% if level_type == 'support' %}Support{% else %}Resistance{% endif %} Prices
                            </th>
                            <th scope="col">Sector</th>
                            <th scope="col">Halal</th>
                            <th scope="col">Volume</th>
                            <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in results %}
                            <tr>
                                <td>
                                    <strong class="text-info">{{ stock.ticker }}</strong>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ stock.company_name or stock.ticker }}</strong>
                                        {% if stock.industry and stock.industry != 'Unknown' %}
                                        <br><small class="text-muted">{{ stock.industry }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {% if stock.asset_type == 'crypto' %}bg-warning{% else %}bg-info{% endif %}">{{ stock.sector or 'Unknown' }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if stock.asset_type == 'crypto' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                        {% if stock.asset_type == 'crypto' %}
                                            <i data-feather="zap" class="me-1" style="width: 12px; height: 12px;"></i>Crypto
                                        {% else %}
                                            <i data-feather="trending-up" class="me-1" style="width: 12px; height: 12px;"></i>Stock
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <strong>
                                        {% if stock.asset_type == 'crypto' %}
                                            ${{ "%.4f"|format(stock.price) if stock.price else 'N/A' }}
                                        {% else %}
                                            ${{ "%.2f"|format(stock.price) if stock.price else 'N/A' }}
                                        {% endif %}
                                    </strong>
                                </td>

<td>
                                <span class="badge {% if level_type == 'support' %}bg-success{% else %}bg-danger{% endif %}">{{ result.zones }}</span>
                            </td>
                            <td>
                                <span class="fw-bold {% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                    {% if level_type == 'support' %}
                                        {{ result.support_prices or result.get('resistance_prices', '—') }}
                                    {% else %}
                                        {{ result.get('resistance_prices', result.support_prices or '—') }}
                                    {% endif %}
                                </span>
                            </td>

<td>
                                <span class="badge {% if level_type == 'support' %}bg-success{% else %}bg-danger{% endif %}">{{ result.zones }}</span>
                            </td>
                            <td>
                                <span class="fw-bold {% if level_type == 'support' %}text-success{% else %}text-danger{% endif %}">
                                    {% if level_type == 'support' %}
                                        {{ result.support_prices or result.get('resistance_prices', '—') }}
                                    {% else %}
                                        {{ result.get('resistance_prices', result.support_prices or '—') }}
                                    {% endif %}
                                </span>
                            </td>
                                <td>
                                    <span class="badge {% if stock.asset_type == 'crypto' %}bg-warning{% else %}bg-info{% endif %}">{{ stock.sector or 'Unknown' }}</span>
                                </td>
                                <td>
                                    {% if stock.asset_type == 'crypto' %}
                                        <span class="badge bg-success">✓ Halal</span>
                                    {% elif stock.is_halal %}
                                        <span class="badge bg-success">✓ Halal</span>
                                    {% else %}
                                        <span class="badge bg-warning">⚠ Non-Halal</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-secondary me-2">{{ stock.popularity or 0 }}</span>
                                        <small class="text-muted">views</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('stock_detail', ticker=stock.ticker) }}" 
                                           class="btn btn-outline-primary">
                                            <i data-feather="eye"></i>
                                        </a>
                                        <a href="{{ url_for('compare') }}?tickers={{ stock.ticker }}" 
                                           class="btn btn-outline-secondary">
                                            <i data-feather="bar-chart-2"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i data-feather="search" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                <h4 class="text-muted">No Stocks Found</h4>
                <p class="text-muted">
                    No stocks are currently within {{ "%.1f"|format(threshold) }}% of their support levels.
                </p>
                <div class="mt-3">
                    <a href="{{ url_for('settings') }}" class="btn btn-primary me-2">
                        <i data-feather="settings" class="me-1"></i>Adjust Threshold
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i data-feather="bar-chart-2" class="me-1"></i>View Dashboard
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set last updated time
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();

    // Set current time for last updated
    const lastUpdatedElement = document.getElementById('lastUpdated');
    if (lastUpdatedElement) {
        lastUpdatedElement.textContent = new Date().toLocaleString();
    }
});
</script>
{% endblock %}