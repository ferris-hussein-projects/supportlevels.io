{% extends "base.html" %}

{% block title %}{{ ticker }} Analysis - Stock Support Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">
                    <span class="text-info">{{ ticker }}</span>
                    {% if analysis and analysis.company_name %}
                        <small class="text-muted">{{ analysis.company_name }}</small>
                    {% endif %}
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('index') }}">Support Tracker</a>
                        </li>
                        <li class="breadcrumb-item active">{{ ticker }}</li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex gap-2">
                {% if analysis and analysis.tradingview_link %}
                <a href="{{ analysis.tradingview_link }}" target="_blank" class="btn btn-success">
                    <i data-feather="trending-up" class="me-1"></i>TradingView Chart
                </a>
                {% endif %}
                <a href="{{ url_for('compare') }}?tickers={{ ticker }}" class="btn btn-outline-primary">
                    <i data-feather="bar-chart-2" class="me-1"></i>Compare
                </a>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i data-feather="printer" class="me-1"></i>Print
                </button>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i data-feather="alert-circle" class="me-2"></i>
            {{ error }}
        </div>
        {% elif analysis %}

        <!-- Price Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Current Price</h5>
                        <h2 class="text-success">
                            ${{ analysis.current_price }}
                            {% if analysis.currency and analysis.currency != 'USD' %}
                                <small class="text-muted">{{ analysis.currency }}</small>
                            {% endif %}
                        </h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">1 Week Change</h5>
                        <h3 class="{% if analysis.change_1w and analysis.change_1w >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if analysis.change_1w %}
                                {{ "%.2f"|format(analysis.change_1w) }}%
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">1 Month Change</h5>
                        <h3 class="{% if analysis.change_1m and analysis.change_1m >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if analysis.change_1m %}
                                {{ "%.2f"|format(analysis.change_1m) }}%
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">3 Month Change</h5>
                        <h3 class="{% if analysis.change_3m and analysis.change_3m >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if analysis.change_3m %}
                                {{ "%.2f"|format(analysis.change_3m) }}%
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i data-feather="trending-up" class="me-2"></i>
                    Price Chart
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadChart('3mo')">3M</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="loadChart('6mo')">6M</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadChart('1y')">1Y</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="priceChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Technical Analysis -->
        <div class="row mb-4">
            <!-- Moving Averages -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="activity" class="me-2"></i>
                            Moving Averages
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="text-center">
                                    <h6 class="text-muted">21-day MA</h6>
                                    <strong>
                                        {% if analysis.ma21 %}
                                            ${{ analysis.ma21 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <h6 class="text-muted">50-day MA</h6>
                                    <strong>
                                        {% if analysis.ma50 %}
                                            ${{ analysis.ma50 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="text-center">
                                    <h6 class="text-muted">200-day MA</h6>
                                    <strong>
                                        {% if analysis.ma200 %}
                                            ${{ analysis.ma200 }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Indicators -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="bar-chart" class="me-2"></i>
                            Technical Indicators
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted">RSI (14)</h6>
                                <strong class="{% if analysis.rsi %}{% if analysis.rsi > 70 %}text-danger{% elif analysis.rsi < 30 %}text-success{% else %}text-warning{% endif %}{% endif %}">
                                    {% if analysis.rsi %}
                                        {{ analysis.rsi }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">MACD</h6>
                                <strong>
                                    {% if analysis.macd %}
                                        {{ analysis.macd }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-muted">Bollinger Bands</h6>
                                <div class="small">
                                    <div>Upper: {% if analysis.bb_upper %}<strong>${{ analysis.bb_upper }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}</div>
                                    <div>Middle: {% if analysis.bb_middle %}<strong>${{ analysis.bb_middle }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}</div>
                                    <div>Lower: {% if analysis.bb_lower %}<strong>${{ analysis.bb_lower }}</strong>{% else %}<span class="text-muted">—</span>{% endif %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Company Information -->
        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="info" class="me-2"></i>
                            Company Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted">Sector</h6>
                                <p>{{ analysis.sector or "—" }}</p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Industry</h6>
                                <p>{{ analysis.industry or "—" }}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted">Halal Status</h6>
                                <p>
                                    {% if analysis.is_halal %}
                                        <span class="badge bg-success">
                                            <i data-feather="check-circle" class="me-1" style="width: 12px; height: 12px;"></i>Halal Compliant
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i data-feather="x-circle" class="me-1" style="width: 12px; height: 12px;"></i>Non-Halal
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Asset Type</h6>
                                <p>
                                    {% if analysis.asset_type == 'crypto' %}
                                        <span class="badge bg-warning text-dark">
                                            <i data-feather="zap" class="me-1" style="width: 12px; height: 12px;"></i>Cryptocurrency
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i data-feather="trending-up" class="me-1" style="width: 12px; height: 12px;"></i>Stock
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted">Market Cap</h6>
                                <p>
                                    {% if analysis.market_cap %}
                                        ${{ "{:,.0f}".format(analysis.market_cap) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">P/E Ratio</h6>
                                <p>
                                    {% if analysis.pe_ratio %}
                                        {{ "%.2f"|format(analysis.pe_ratio) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="bar-chart-2" class="me-2"></i>
                            Volume Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6 class="text-muted">Current Volume</h6>
                                <p>
                                    {% if analysis.volume %}
                                        {{ "{:,}".format(analysis.volume) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">30-day Avg Volume</h6>
                                <p>
                                    {% if analysis.avg_volume_30d %}
                                        {{ "{:,}".format(analysis.avg_volume_30d) }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-muted">Dividend Yield</h6>
                                <p>
                                    {% if analysis.dividend_yield %}
                                        {{ "%.2f"|format(analysis.dividend_yield * 100) }}%
                                    {% else %}
                                        —
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentChart = null;

function loadChart(period = '6mo') {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event?.target?.classList.add('active');
    
    fetch(`/api/chart_data/{{ ticker }}?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Chart data error:', data.error);
                return;
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: 'Price',
                            data: data.prices,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: '21-day MA',
                            data: data.ma21,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: '50-day MA',
                            data: data.ma50,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
}

// Load default chart on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChart('6mo');
    feather.replace();
});
</script>
{% endblock %}
